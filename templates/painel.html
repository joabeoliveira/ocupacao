<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocupação de Leitos - NIR Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ghcgreen: '#599E33',
              ghcturquoise: '#008B8B',
              ghclight: '#DFE7CF',
              ghcwhite: '#FFFFFF',
            }
          }
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Variáveis de tema */
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1F2937;
            --bg-tertiary: #374151;
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
            --text-tertiary: #9CA3AF;
            --border-color: #374151;
            --card-bg: linear-gradient(to bottom right, #1F2937, #111827);
            --sidebar-bg: #000000;
            --chart-blue: rgba(59, 130, 246, 0.8);
            --chart-green: rgba(34, 197, 94, 0.8);
            --chart-text: #F9FAFB;
            --chart-grid: rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="light"] {
            --bg-primary: #F3F4F6;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #E5E7EB;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-tertiary: #6B7280;
            --border-color: #E5E7EB;
            --card-bg: linear-gradient(to bottom right, #FFFFFF, #F9FAFB);
            --sidebar-bg: #1E3A8A;
            --chart-blue: rgba(37, 99, 235, 0.8);
            --chart-green: rgba(22, 163, 74, 0.8);
            --chart-text: #111827;
            --chart-grid: rgba(0, 0, 0, 0.1);
        }
        
        /* Classes utilitárias para tema */
        .bg-theme-primary { background-color: var(--bg-primary); }
        .bg-theme-secondary { background: var(--card-bg); }
        .text-theme-primary { color: var(--text-primary); }
        .text-theme-secondary { color: var(--text-secondary); }
        .text-theme-tertiary { color: var(--text-tertiary); }
        .border-theme { border-color: var(--border-color); }
        
        /* Estilos para inputs e selects - texto sempre legível */
        input, select {
            background-color: #FFFFFF !important;
            color: #111827 !important;
            border-color: #D1D5DB !important;
        }
        input::placeholder {
            color: #6B7280 !important;
        }
        
        /* Responsive mobile menu */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9;
        }
        .menu-overlay.active {
            display: block;
        }
        @media (max-width: 768px) {
            .sidebar {
                z-index: 20 !important;
            }
            .sidebar-hidden {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0 !important;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
        }
    </style>
</head>
<body class="font-sans" style="background-color: var(--bg-primary);">
    <!-- Mobile Menu Overlay -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMobileMenu()"></div>
    
    <!-- Mobile Hamburger Button -->
    <button onclick="toggleMobileMenu()" class="fixed top-4 left-4 z-30 md:hidden bg-blue-600 text-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars" id="hamburger-icon"></i>
    </button>

    <!-- Sidebar -->
    <div class="flex">
        <aside class="sidebar sidebar-hidden md:sidebar-hidden-none w-64 h-screen text-white flex flex-col fixed left-0 top-0 z-10 shadow-2xl" id="sidebar" style="background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);">
            <div class="flex flex-col items-center justify-center h-20 py-2" style="border-bottom: 1px solid #1E40AF;">
                <div class="flex items-center">
                    <i class="fas fa-hospital-alt fa-2x mr-2"></i>
                    <span class="font-semibold text-xl tracking-tight">NIR Dashboard</span>
                </div>
                <span class="text-xs text-gray-400 mt-1" id="app-version">v3.1.0</span>
            </div>
            <nav class="flex-1 py-6">
                <ul class="space-y-2">
                    <li>
                        <a href="/painel" class="flex items-center px-6 py-3 bg-blue-800 rounded transition">
                            <i class="fas fa-bed mr-3"></i>
                            Ocupação de Leitos
                        </a>
                    </li>
                    <li>
                        <a href="/tempo_permanencia" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition">
                            <i class="fas fa-clock mr-3"></i>
                            Tempo de Permanência
                        </a>
                    </li>
                    <li>
                        <a href="/" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition">
                            <i class="fas fa-file-upload mr-3"></i>
                            Importação e Histórico
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-1 md:ml-64">
            <div class="container mx-auto mt-16 md:mt-8 px-4 pb-12">
                <!-- Header -->
                <nav class="bg-gradient-to-r from-gray-800 to-gray-900 p-4 shadow-2xl rounded-lg mb-6 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-ghcwhite font-semibold text-2xl">
                                <i class="fas fa-chart-bar mr-2"></i>
                                Painel de Ocupação de Leitos
                            </h1>
                            <div id="filters-active" class="text-sm text-gray-400 mt-1 hidden">
                                <i class="fas fa-filter mr-1"></i>
                                <span id="filters-text">Filtros ativos</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleTheme()" id="theme-toggle"
                                class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
                                <i class="fas fa-sun" id="theme-icon"></i>
                            </button>
                            <button onclick="toggleFilters()" 
                                class="bg-blue-900 hover:bg-blue-800 text-white px-4 py-2 rounded transition">
                                <i class="fas fa-filter mr-2"></i>
                                Filtros
                            </button>
                            <button onclick="refreshData()" 
                                class="bg-blue-900 hover:bg-blue-800 text-white px-4 py-2 rounded transition">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Atualizar
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Filters Panel -->
                <div id="filters-panel" class="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 hidden animate-fade-in border border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-4">
                        <i class="fas fa-filter mr-2 text-ghcturquoise"></i>
                        Filtros Avançados
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-building mr-1"></i>
                                Prédio
                            </label>
                            <select id="filter-predio"
                                class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todos</option>
                                <option value="1">Prédio 1</option>
                                <option value="2">Prédio 2</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                Período Inicial
                            </label>
                            <input type="date" id="filter-periodo-inicio"
                                class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-calendar-check mr-1"></i>
                                Período Final
                            </label>
                            <input type="date" id="filter-periodo-fim"
                                class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-calendar mr-1"></i>
                                Mês
                            </label>
                            <select id="filter-mes"
                                class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todos</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-hospital-user mr-1"></i>
                                Clínica
                            </label>
                            <select id="filter-clinica"
                                class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="applyFilters()" 
                            class="bg-ghcturquoise hover:bg-ghcgreen text-white px-6 py-2 rounded-lg transition">
                            <i class="fas fa-check mr-2"></i>
                            Aplicar Filtros
                        </button>
                        <button onclick="clearFilters()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition">
                            <i class="fas fa-times mr-2"></i>
                            Limpar
                        </button>
                    </div>
                </div>

                <!-- Loading Skeleton -->
                <div id="loading-skeleton" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="skeleton h-28 rounded-lg"></div>
                        <div class="skeleton h-28 rounded-lg"></div>
                        <div class="skeleton h-28 rounded-lg"></div>
                        <div class="skeleton h-28 rounded-lg"></div>
                        <div class="skeleton h-28 rounded-lg"></div>
                    </div>
                    <div class="skeleton h-96 rounded-lg"></div>
                </div>

                <!-- Stats Cards -->
                <div id="stats-section" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 animate-fade-in">
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-blue-500 card-hover border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-gray-500 text-xs font-bold uppercase mb-2">
                                        <i class="fas fa-user-injured mr-1"></i>
                                        Ocupados
                                    </div>
                                    <div class="text-4xl font-bold text-blue-400" id="stat-ocupados">0</div>
                                </div>
                                <div class="text-blue-500 text-3xl">
                                    <i class="fas fa-procedures"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-green-500 card-hover border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-gray-400 text-xs font-bold uppercase mb-2">
                                        <i class="fas fa-bed mr-1"></i>
                                        Livres
                                    </div>
                                    <div class="text-4xl font-bold text-green-400" id="stat-livres">0</div>
                                </div>
                                <div class="text-green-500 text-3xl">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-yellow-500 card-hover border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-gray-400 text-xs font-bold uppercase mb-2">
                                        <i class="fas fa-exchange-alt mr-1"></i>
                                        Cedidos
                                    </div>
                                    <div class="text-4xl font-bold text-yellow-400" id="stat-cedidos">0</div>
                                </div>
                                <div class="text-yellow-500 text-3xl">
                                    <i class="fas fa-hands-helping"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-red-500 card-hover border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-gray-400 text-xs font-bold uppercase mb-2">
                                        <i class="fas fa-tools mr-1"></i>
                                        Impedidos
                                    </div>
                                    <div class="text-4xl font-bold text-red-400" id="stat-impedidos">0</div>
                                </div>
                                <div class="text-red-500 text-3xl">
                                    <i class="fas fa-ban"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-purple-500 card-hover border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-gray-400 text-xs font-bold uppercase mb-2">
                                        <i class="fas fa-clock mr-1"></i>
                                        Reservados
                                    </div>
                                    <div class="text-4xl font-bold text-purple-400" id="stat-reservados">0</div>
                                </div>
                                <div class="text-purple-500 text-3xl">
                                    <i class="fas fa-bookmark"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secondary Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 animate-fade-in">
                        <div class="bg-gradient-to-br from-ghcturquoise to-blue-600 rounded-lg p-6 shadow-lg text-white card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-white text-sm font-semibold uppercase mb-2">Taxa de Ocupação Geral</div>
                                    <div class="text-3xl font-bold" id="taxa-geral">0%</div>
                                </div>
                                <svg class="progress-ring" width="60" height="60">
                                    <circle class="text-white opacity-30" stroke="currentColor" stroke-width="4" 
                                        fill="transparent" r="26" cx="30" cy="30"/>
                                    <circle id="progress-ring-geral" class="progress-ring-circle text-white" stroke="currentColor" 
                                        stroke-width="4" fill="transparent" r="26" cx="30" cy="30"
                                        stroke-dasharray="163.36" stroke-dashoffset="163.36"/>
                                </svg>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-red-500 to-red-700 rounded-lg p-6 shadow-lg text-white card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-white text-sm font-semibold uppercase mb-2">% Leitos Impedidos</div>
                                    <div class="text-3xl font-bold" id="taxa-impedidos">0%</div>
                                </div>
                                <svg class="progress-ring" width="60" height="60">
                                    <circle class="text-white opacity-30" stroke="currentColor" stroke-width="4" 
                                        fill="transparent" r="26" cx="30" cy="30"/>
                                    <circle id="progress-ring-impedidos" class="progress-ring-circle text-white" stroke="currentColor" 
                                        stroke-width="4" fill="transparent" r="26" cx="30" cy="30"
                                        stroke-dasharray="163.36" stroke-dashoffset="163.36"/>
                                </svg>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-gray-600 to-gray-800 rounded-lg p-6 shadow-lg text-white card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-white text-sm font-semibold uppercase mb-2">Total de Leitos</div>
                                    <div class="text-3xl font-bold" id="stat-total">0</div>
                                </div>
                                <div class="text-white text-4xl">
                                    <i class="fas fa-hospital"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl card-hover animate-fade-in border border-gray-700">
                            <h3 class="font-bold text-white mb-4 text-lg">
                                <i class="fas fa-chart-line mr-2 text-blue-400"></i>
                                Evolução Mensal da Ocupação
                            </h3>
                            <div style="height: 300px">
                                <canvas id="grafico-evolucao"></canvas>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl card-hover animate-fade-in border border-gray-700">
                            <h3 class="font-bold text-white mb-4 text-lg">
                                <i class="fas fa-chart-bar mr-2 text-green-400"></i>
                                Taxa de Ocupação por Clínica
                            </h3>
                            <div style="height: 300px">
                                <canvas id="grafico-clinica"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let evolucaoChart = null;
        let clinicaChart = null;
        let currentFilters = {};

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update icon
            const icon = document.getElementById('theme-icon');
            icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            
            // Reload charts with new theme colors
            if (evolucaoChart) loadEvolucaoChart();
            if (clinicaChart) loadClinicaChart();
        }
        
        // Load theme from localStorage
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }
        }
        
        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('menu-overlay');
            const icon = document.getElementById('hamburger-icon');
            
            sidebar.classList.toggle('sidebar-hidden');
            overlay.classList.toggle('active');
            
            if (sidebar.classList.contains('sidebar-hidden')) {
                icon.className = 'fas fa-bars';
            } else {
                icon.className = 'fas fa-times';
            }
        }
        
        // Close mobile menu on window resize to desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('menu-overlay');
                sidebar.classList.remove('sidebar-hidden');
                overlay.classList.remove('active');
            }
        });

        // Toggle filters panel
        function toggleFilters() {
            const panel = document.getElementById('filters-panel');
            panel.classList.toggle('hidden');
        }

        // Apply filters
        function applyFilters() {
            currentFilters = {
                predio: document.getElementById('filter-predio').value,
                periodo_inicio: document.getElementById('filter-periodo-inicio').value,
                periodo_fim: document.getElementById('filter-periodo-fim').value,
                mes: document.getElementById('filter-mes').value,
                clinica: document.getElementById('filter-clinica').value
            };
            
            // Remove empty filters
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) delete currentFilters[key];
            });
            
            // Mostra indicador de filtros ativos
            updateFiltersIndicator();
            
            refreshData();
            toggleFilters();
        }

        // Update filters indicator
        function updateFiltersIndicator() {
            const indicator = document.getElementById('filters-active');
            const filtersText = document.getElementById('filters-text');
            
            if (Object.keys(currentFilters).length > 0) {
                const filterLabels = [];
                if (currentFilters.predio) filterLabels.push(`Prédio ${currentFilters.predio}`);
                if (currentFilters.periodo_inicio && currentFilters.periodo_fim) {
                    filterLabels.push(`${currentFilters.periodo_inicio} a ${currentFilters.periodo_fim}`);
                }
                if (currentFilters.mes) {
                    const meses = ['', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                    filterLabels.push(`Mês: ${meses[parseInt(currentFilters.mes)]}`);
                }
                if (currentFilters.clinica) filterLabels.push(`Clínica: ${currentFilters.clinica}`);
                
                filtersText.textContent = `Filtros: ${filterLabels.join(' | ')}`;
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filter-predio').value = '';
            document.getElementById('filter-periodo-inicio').value = '';
            document.getElementById('filter-periodo-fim').value = '';
            document.getElementById('filter-mes').value = '';
            document.getElementById('filter-clinica').value = '';
            currentFilters = {};
            updateFiltersIndicator();
            refreshData();
        }

        // Load clinicas for filter
        async function loadClinicasFilter() {
            try {
                const response = await fetch('/api/painel/clinicas');
                const data = await response.json();
                
                if (data.error) return;
                
                const select = document.getElementById('filter-clinica');
                data.labels.forEach(clinica => {
                    const option = document.createElement('option');
                    option.value = clinica;
                    option.textContent = clinica;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar clínicas para filtro:', error);
            }
        }

        // Update progress ring
        function updateProgressRing(elementId, percent) {
            const circle = document.getElementById(elementId);
            const circumference = 163.36;
            const offset = circumference - (percent / 100 * circumference);
            circle.style.strokeDashoffset = offset;
        }

        // Load stats
        async function loadStats() {
            try {
                // Monta query string com filtros
                const queryParams = new URLSearchParams(currentFilters).toString();
                const url = queryParams ? `/api/painel/stats?${queryParams}` : '/api/painel/stats';
                
                const response = await fetch(url);
                const stats = await response.json();
                
                if (stats.error) {
                    console.error('Erro ao carregar stats:', stats.error);
                    return;
                }
                
                document.getElementById('stat-ocupados').textContent = stats.ocupados;
                document.getElementById('stat-livres').textContent = stats.livres;
                document.getElementById('stat-cedidos').textContent = stats.cedidos;
                document.getElementById('stat-impedidos').textContent = stats.impedidos;
                document.getElementById('stat-reservados').textContent = stats.reservados;
                document.getElementById('stat-total').textContent = stats.total;
                
                const taxaGeral = ((stats.ocupados / stats.total) * 100).toFixed(1);
                const taxaImpedidos = ((stats.impedidos / stats.total) * 100).toFixed(1);
                
                document.getElementById('taxa-geral').textContent = taxaGeral + '%';
                document.getElementById('taxa-impedidos').textContent = taxaImpedidos + '%';
                
                updateProgressRing('progress-ring-geral', taxaGeral);
                updateProgressRing('progress-ring-impedidos', taxaImpedidos);
                
                document.getElementById('loading-skeleton').classList.add('hidden');
                document.getElementById('stats-section').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Load evolução chart
        async function loadEvolucaoChart() {
            try {
                // Monta query string com filtros
                const queryParams = new URLSearchParams(currentFilters).toString();
                const url = queryParams ? `/api/painel/evolucao?${queryParams}` : '/api/painel/evolucao';
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) return;
                
                const ctx = document.getElementById('grafico-evolucao').getContext('2d');
                
                if (evolucaoChart) {
                    evolucaoChart.destroy();
                }
                
                // Cores baseadas no tema usando variáveis CSS
                const theme = document.documentElement.getAttribute('data-theme');
                const isDark = theme !== 'light';
                const styles = getComputedStyle(document.documentElement);
                const chartBlue = styles.getPropertyValue('--chart-blue').trim();
                const chartText = styles.getPropertyValue('--chart-text').trim();
                const chartGrid = styles.getPropertyValue('--chart-grid').trim();
                const lineColor = isDark ? '#60A5FA' : '#2563EB';
                const gridColor = chartGrid || (isDark ? '#374151' : '#E5E7EB');
                const textColor = chartText || (isDark ? '#9CA3AF' : '#6B7280');
                const legendColor = isDark ? '#E5E7EB' : '#374151';
                const bgColor = isDark ? 'rgba(96,165,250,0.12)' : 'rgba(37,99,235,0.20)';

                // Plugin para aplicar sombra sutil sob as linhas/barras
                const chartShadowPlugin = {
                    id: 'shadowPlugin',
                    beforeDatasetsDraw(chart, args, options) {
                        const ctx = chart.ctx;
                        ctx.save();
                        const cfg = chart.config.options.plugins && chart.config.options.plugins.shadow || {};
                        ctx.shadowColor = cfg.color || (isDark ? 'rgba(0,0,0,0.6)' : 'rgba(16,24,40,0.06)');
                        ctx.shadowBlur = cfg.blur || 12;
                    },
                    afterDatasetsDraw(chart, args, options) {
                        chart.ctx.restore();
                    }
                };

                evolucaoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Taxa de Ocupação (%)',
                            data: data.data,
                            borderColor: lineColor,
                            backgroundColor: bgColor,
                            borderWidth: 3,
                            tension: 0.35,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    plugins: [chartShadowPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            shadow: { color: isDark ? 'rgba(0,0,0,0.6)' : 'rgba(16,24,40,0.06)', blur: 12 },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { color: legendColor }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar gráfico de evolução:', error);
            }
        }

        // Load clinica chart
        async function loadClinicaChart() {
            try {
                // Monta query string com filtros
                const queryParams = new URLSearchParams(currentFilters).toString();
                const url = queryParams ? `/api/painel/clinicas?${queryParams}` : '/api/painel/clinicas';
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) return;
                
                const ctx = document.getElementById('grafico-clinica').getContext('2d');
                
                if (clinicaChart) {
                    clinicaChart.destroy();
                }
                
                // Cores baseadas no tema usando variáveis CSS
                const theme = document.documentElement.getAttribute('data-theme');
                const isDark = theme !== 'light';
                const styles = getComputedStyle(document.documentElement);
                const chartGreen = styles.getPropertyValue('--chart-green').trim();
                const chartText = styles.getPropertyValue('--chart-text').trim();
                const chartGrid = styles.getPropertyValue('--chart-grid').trim();
                const barColor = isDark ? '#34D399' : '#16A34A';
                const barBorder = isDark ? '#10B981' : '#15803D';
                const gridColor = chartGrid || (isDark ? '#374151' : '#E5E7EB');
                const textColor = chartText || (isDark ? '#9CA3AF' : '#6B7280');

                const chartShadowPlugin = {
                    id: 'shadowPlugin',
                    beforeDatasetsDraw(chart, args, options) {
                        const ctx = chart.ctx;
                        ctx.save();
                        const cfg = chart.config.options.plugins && chart.config.options.plugins.shadow || {};
                        ctx.shadowColor = cfg.color || (isDark ? 'rgba(0,0,0,0.6)' : 'rgba(16,24,40,0.06)');
                        ctx.shadowBlur = cfg.blur || 10;
                    },
                    afterDatasetsDraw(chart, args, options) {
                        chart.ctx.restore();
                    }
                };

                clinicaChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Taxa de Ocupação (%)',
                            data: data.data,
                            backgroundColor: isDark ? barColor : 'rgba(22,163,74,0.70)',
                            borderColor: barBorder,
                            borderWidth: 1
                        }]
                    },
                    plugins: [chartShadowPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: gridColor }
                            },
                            y: {
                                ticks: { color: textColor },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            shadow: { color: isDark ? 'rgba(0,0,0,0.6)' : 'rgba(16,24,40,0.06)', blur: 10 },
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Ocupação: ' + context.parsed.x + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar gráfico de clínicas:', error);
            }
        }

        // Refresh all data
        function refreshData() {
            document.getElementById('stats-section').classList.add('hidden');
            document.getElementById('loading-skeleton').classList.remove('hidden');
            
            loadStats();
            loadEvolucaoChart();
            loadClinicaChart();
        }

        // Load version
        async function loadVersion() {
            try {
                const response = await fetch('/api/version');
                const data = await response.json();
                document.getElementById('app-version').textContent = `v${data.version}`;
            } catch (error) {
                console.log('Versão estática mantida');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadVersion();
            loadStats();
            loadEvolucaoChart();
            loadClinicaChart();
            loadClinicasFilter();
        });
    </script>
</body>
</html>
