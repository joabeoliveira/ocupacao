<!DOCTYPE html>
<html class="dark" lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disponibilidade de Leitos - NIR Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            "primary": "#0b72d9",
                            "background-light": "#f7fbff",
                            "background-dark": "#0f1724",
                            "surface-light": "#ffffff",
                            "surface-dark": "#111827",
                            "text-primary-light": "#0b1724",
                            "text-primary-dark": "#e6eef8",
                            "text-secondary-light": "#4b5563",
                            "text-secondary-dark": "#9fb6d8",
                        }
                    }
                }
            }
        </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Variáveis de tema */
        :root {
            --bg-primary: #0f1724;
            --bg-secondary: #111827;
            --bg-tertiary: #0b1a2a;
            --text-primary: #e6eef8;
            --text-secondary: #9fb6d8;
            --text-tertiary: #9fb6d8;
            --border-color: #111827;
            --card-bg: linear-gradient(to bottom right, #111827, #0f1724);
            --sidebar-bg: #071025;
            --chart-blue: rgba(11, 114, 217, 0.85);
            --chart-green: rgba(22, 163, 74, 0.85);
            --chart-text: #e6eef8;
            --chart-grid: rgba(255, 255, 255, 0.06);
        }
        
        [data-theme="light"] {
            --bg-primary: #f7fbff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0b1724;
            --text-secondary: #4b5563;
            --text-tertiary: #6B7280;
            --border-color: #E5E7EB;
            --card-bg: linear-gradient(to bottom right, #ffffff, #f7fbff);
            --sidebar-bg: #1E3A8A;
            --chart-blue: rgba(11, 114, 217, 0.85);
            --chart-green: rgba(22, 163, 74, 0.85);
            --chart-text: #0b1724;
            --chart-grid: rgba(0, 0, 0, 0.06);
        }
        
        /* Classes utilitárias para tema */
        .bg-theme-primary { background-color: var(--bg-primary); }
        .bg-theme-secondary { background: var(--card-bg); }
        .text-theme-primary { color: var(--text-primary); }
        .text-theme-secondary { color: var(--text-secondary); }
        .text-theme-tertiary { color: var(--text-tertiary); }
        .border-theme { border-color: var(--border-color); }
        
        /* Estilos para inputs e selects - texto sempre legível */
        input, select {
            background-color: #FFFFFF !important;
            color: #111827 !important;
            border-color: #D1D5DB !important;
        }
        input::placeholder {
            color: #6B7280 !important;
        }
        
        /* Responsive mobile menu */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: none;
        }
        .sidebar-hidden { transform: translateX(-100%); }
        @media (max-width: 768px) {
            .sidebar { z-index: 20 !important; }
            .main-content { margin-left: 0 !important; }
        }
        @media (min-width: 769px) {
            .sidebar { transform: none !important; }
            .menu-overlay { display: none !important; }
        }
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9;
        }
        .menu-overlay.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="font-sans" style="background-color: var(--bg-primary);">
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMobileMenu()"></div>
    <button onclick="toggleMobileMenu()" class="hamburger-btn fixed top-4 left-4 z-30 md:hidden bg-blue-600 text-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars" id="hamburger-icon"></i>
    </button>
    <div class="flex">
        <aside class="sidebar w-64 h-screen text-white flex flex-col fixed left-0 top-0 z-10 shadow-2xl" id="sidebar" style="background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);">
            <div class="flex flex-col items-center justify-center h-20 py-2" style="border-bottom: 1px solid #1E40AF;">
                <div class="flex items-center"><i class="fas fa-hospital-alt fa-2x mr-2"></i><span class="font-semibold text-xl tracking-tight">NIR Dashboard</span></div>
                <span class="text-xs text-gray-400 mt-1" id="app-version">v3.1.0</span>
            </div>
            <nav class="flex-1 py-6"><ul class="space-y-2">
                <li><a href="/painel" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition"><i class="fas fa-bed mr-3"></i>Ocupação de Leitos</a></li>
                <li><a href="/tempo_permanencia" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition"><i class="fas fa-clock mr-3"></i>Tempo de Permanência</a></li>
                <li><a href="/disponibilidade" class="flex items-center px-6 py-3 bg-blue-800 rounded transition"><i class="fas fa-chart-area mr-3"></i>Disponibilidade</a></li>
                <li><a href="/" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition"><i class="fas fa-file-upload mr-3"></i>Importação e Histórico</a></li>
            </ul></nav>
        </aside>
        <div class="main-content flex-1 md:ml-64">
            <div class="container mx-auto mt-16 md:mt-8 px-4 pb-12">
                <nav class="bg-gradient-to-r from-gray-800 to-gray-900 p-4 shadow-2xl rounded-lg mb-6 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <h1 class="text-white font-semibold text-2xl"><i class="fas fa-chart-area mr-2"></i>Disponibilidade de Leitos</h1>
                        <div class="flex items-center gap-2">
                            <div id="filters-active" class="hidden text-sm bg-blue-900 px-4 py-2 rounded text-white" style="display:flex;align-items:center">
                                <i class="fas fa-filter mr-2"></i><span id="filters-text">Filtros ativos</span>
                            </div>
                            <button onclick="toggleFilters()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition ml-2"><i class="fas fa-filter"></i></button>
                            <button onclick="toggleTheme()" id="theme-toggle" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition ml-2"><i class="fas fa-sun" id="theme-icon"></i></button>
                        </div>
                    </div>
                </nav>

                <div id="filters-panel" class="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 hidden animate-fade-in border border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-filter mr-2 text-blue-400"></i>Filtros Avançados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2"><i class="fas fa-building mr-1"></i>Prédio</label>
                            <select id="filter-predio" class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todos</option><option value="1">Prédio 1</option><option value="2">Prédio 2</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2"><i class="fas fa-calendar-alt mr-1"></i>Período Inicial</label>
                            <input type="date" id="filter-periodo-inicio" class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2"><i class="fas fa-calendar-check mr-1"></i>Período Final</label>
                            <input type="date" id="filter-periodo-fim" class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2"><i class="fas fa-calendar mr-1"></i>Mês</label>
                            <select id="filter-mes" class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todos</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2"><i class="fas fa-hospital-user mr-1"></i>Clínica</label>
                            <select id="filter-clinica" class="w-full px-3 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="applyFilters()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition"><i class="fas fa-check mr-2"></i>Aplicar Filtros</button>
                        <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition"><i class="fas fa-times mr-2"></i>Limpar</button>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-2xl card-hover animate-fade-in border border-gray-700">
                    <div style="height:420px" class="chart-card"><canvas id="dispChart"></canvas></div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-2xl card-hover animate-fade-in border border-gray-700 mt-4">
                    <h3 class="font-bold text-white mb-4 text-lg">
                        <i class="fas fa-ban mr-2 text-red-400"></i>
                        Top 10 - Motivos de Impedimento (percentual)
                    </h3>
                    <div style="height:320px">
                        <canvas id="impedimentosPieChart"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    let currentFilters = {};
    let dispChart = null;
    let impedimentosPieInst = null;

    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        const icon = document.getElementById('theme-icon'); if (icon) icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        if (dispChart) loadDisponibilidade();
    }

    function loadTheme() { const savedTheme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', savedTheme); const icon = document.getElementById('theme-icon'); if (icon) icon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun'; }

    function toggleMobileMenu() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('menu-overlay'); const icon = document.getElementById('hamburger-icon'); sidebar.classList.toggle('sidebar-hidden'); overlay.classList.toggle('active'); icon.className = sidebar.classList.contains('sidebar-hidden') ? 'fas fa-bars' : 'fas fa-times'; }

    function initMobileMenu() { if (window.innerWidth < 768) { const sidebar = document.getElementById('sidebar'); sidebar.classList.add('sidebar-hidden'); } }

    window.addEventListener('resize', () => { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('menu-overlay'); if (window.innerWidth >= 768) { sidebar.classList.remove('sidebar-hidden'); overlay.classList.remove('active'); } else if (!overlay.classList.contains('active')) { sidebar.classList.add('sidebar-hidden'); } });

    function toggleFilters() { const panel = document.getElementById('filters-panel'); panel.classList.toggle('hidden'); }

    function updateFiltersIndicator() {
        const indicator = document.getElementById('filters-active'); const filtersText = document.getElementById('filters-text');
        if (Object.keys(currentFilters).length > 0) {
            const filterLabels = [];
            if (currentFilters.predio) filterLabels.push(`Prédio ${currentFilters.predio}`);
            if (currentFilters.periodo_inicio && currentFilters.periodo_fim) filterLabels.push(`${currentFilters.periodo_inicio} a ${currentFilters.periodo_fim}`);
            if (currentFilters.mes) { const meses = ['', 'Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']; filterLabels.push(`Mês: ${meses[parseInt(currentFilters.mes)]}`); }
            if (currentFilters.clinica) filterLabels.push(`Clínica: ${currentFilters.clinica}`);
            filtersText.textContent = `Filtros: ${filterLabels.join(' | ')}`; indicator.classList.remove('hidden');
        } else { indicator.classList.add('hidden'); }
    }

    function applyFilters() {
        currentFilters = { predio: document.getElementById('filter-predio').value, periodo_inicio: document.getElementById('filter-periodo-inicio').value, periodo_fim: document.getElementById('filter-periodo-fim').value, mes: document.getElementById('filter-mes').value, clinica: document.getElementById('filter-clinica').value };
        Object.keys(currentFilters).forEach(k => { if (!currentFilters[k]) delete currentFilters[k]; });
        updateFiltersIndicator(); loadDisponibilidade(); toggleFilters();
    }

    function clearFilters() { document.getElementById('filter-predio').value=''; document.getElementById('filter-periodo-inicio').value=''; document.getElementById('filter-periodo-fim').value=''; document.getElementById('filter-mes').value=''; document.getElementById('filter-clinica').value=''; currentFilters = {}; updateFiltersIndicator(); loadDisponibilidade(); }

    async function loadClinicasFilter() { try { const response = await fetch('/api/painel/clinicas'); const data = await response.json(); if (data.error) return; const select = document.getElementById('filter-clinica'); select.innerHTML = '<option value="">Todas</option>'; data.labels.forEach(cl => { const o = document.createElement('option'); o.value = cl; o.textContent = cl; select.appendChild(o); }); } catch(e){console.error(e);} }

    async function loadDisponibilidade() {
        try {
            const params = new URLSearchParams(currentFilters).toString();
            const url = params ? '/api/disponibilidade?' + params : '/api/disponibilidade';
            const res = await fetch(url);
            const json = await res.json(); if (json.error) { console.error(json.error); return; }
            const ctx = document.getElementById('dispChart').getContext('2d'); if (dispChart) dispChart.destroy();
            const datasets = json.datasets.map(ds => Object.assign({ tension:0.25, pointRadius:2, yAxisID:'y' }, ds));
            dispChart = new Chart(ctx, { data: { labels: json.labels, datasets: datasets }, options: { responsive:true, maintainAspectRatio:false, scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true} }, plugins:{ legend:{ position:'top' } } } });
            // load impediments pie chart after disponibilidade data (respects currentFilters)
            loadImpedimentosPieChart();
        } catch(err){ console.error('Erro carregando disponibilidade:', err); }
    }

    // Load Top-10 impediments pie chart (percentages)
    async function loadImpedimentosPieChart(){
        try{
            const qs = new URLSearchParams(currentFilters).toString();
            const res = await fetch('/api/painel/impedimentos' + (qs ? ('?' + qs) : ''));
            const json = await res.json(); if(json.error) return;
            // take top 10
            const labels = (json.labels || []).slice(0,10);
            const data = (json.data || []).slice(0,10);
            const total = data.reduce((s,v)=>s+v,0) || 1;
            const percentLabels = labels.map((l,i)=>`${l} (${((data[i]/total)*100).toFixed(1)}%)`);
            const ctx = document.getElementById('impedimentosPieChart').getContext('2d');
            if(impedimentosPieInst) impedimentosPieInst.destroy();
            impedimentosPieInst = new Chart(ctx, {
                type: 'pie',
                data: { labels: percentLabels, datasets: [{ data: data, backgroundColor: ['#ef4444','#f97316','#f59e0b','#facc15','#84cc16','#22c55e','#06b6d4','#3b82f6','#7c3aed','#ec4899'] }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color: getComputedStyle(document.documentElement).getPropertyValue('--chart-text') || '#ddd' } }, tooltip:{ callbacks:{ label: function(context){ const val = context.parsed; const pct = ((val/total)*100).toFixed(1); return `${context.label}: ${val} (${pct}%)`; } } } } }
            });
        }catch(e){ console.error('Erro ao carregar impedimentos (disponibilidade):', e); }
    }

    // load version
    async function loadVersion(){
        try{ const r = await fetch('/api/version'); const j = await r.json(); document.getElementById('app-version').textContent = `v${j.version}`; }catch(e){/*ignore*/}
    }
    
    window.addEventListener('DOMContentLoaded', () => { 
        loadTheme(); 
        initMobileMenu(); 
        loadClinicasFilter(); 
        loadDisponibilidade();
        loadVersion();
    });
</script>
</body>
</html>
