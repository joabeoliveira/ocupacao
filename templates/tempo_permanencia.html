<!DOCTYPE html>
<html class="dark" lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo de Permanência - NIR Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            "primary": "#0b72d9",
                            "background-light": "#f7fbff",
                            "background-dark": "#0f1724",
                            "surface-light": "#ffffff",
                            "surface-dark": "#111827",
                            "text-primary-light": "#0b1724",
                            "text-primary-dark": "#e6eef8",
                            "text-secondary-light": "#4b5563",
                            "text-secondary-dark": "#9fb6d8",
                        }
                    }
                }
            }
        </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Variáveis de tema */
        :root {
            --bg-primary: #0f1724;
            --bg-secondary: #111827;
            --bg-tertiary: #0b1a2a;
            --text-primary: #e6eef8;
            --text-secondary: #9fb6d8;
            --text-tertiary: #9fb6d8;
            --border-color: #111827;
            --card-bg: linear-gradient(to bottom right, #111827, #0f1724);
            --sidebar-bg: #071025;
            --chart-blue: rgba(11, 114, 217, 0.85);
            --chart-green: rgba(22, 163, 74, 0.85);
            --chart-text: #e6eef8;
            --chart-grid: rgba(255, 255, 255, 0.06);
        }
        
        [data-theme="light"] {
            --bg-primary: #f7fbff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0b1724;
            --text-secondary: #4b5563;
            --text-tertiary: #6B7280;
            --border-color: #E5E7EB;
            --card-bg: linear-gradient(to bottom right, #ffffff, #f7fbff);
            --sidebar-bg: #1E3A8A;
            --chart-blue: rgba(11, 114, 217, 0.85);
            --chart-green: rgba(22, 163, 74, 0.85);
            --chart-text: #0b1724;
            --chart-grid: rgba(0, 0, 0, 0.06);
        }
        
        /* Classes utilitárias para tema */
        .bg-theme-primary { background-color: var(--bg-primary); }
        .bg-theme-secondary { background: var(--card-bg); }
        .text-theme-primary { color: var(--text-primary); }
        .text-theme-secondary { color: var(--text-secondary); }
        .text-theme-tertiary { color: var(--text-tertiary); }
        .border-theme { border-color: var(--border-color); }
        
        /* Estilos para inputs e selects - texto sempre legível */
        input, select {
            background-color: #FFFFFF !important;
            color: #111827 !important;
            border-color: #D1D5DB !important;
        }
        input::placeholder {
            color: #6B7280 !important;
        }
        
        /* Responsive mobile menu */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: none;
        }
        .sidebar-hidden { transform: translateX(-100%); }
        @media (max-width: 768px) {
            .sidebar { z-index: 20 !important; }
            .main-content { margin-left: 0 !important; }
        }
        @media (min-width: 769px) {
            .sidebar { transform: none !important; }
            .menu-overlay { display: none !important; }
        }
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9;
        }
        .menu-overlay.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="font-sans" style="background-color: var(--bg-primary); min-height:100vh;">
    <!-- Mobile Menu Overlay -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMobileMenu()"></div>
    
    <!-- Mobile Hamburger Button -->
    <button onclick="toggleMobileMenu()" class="hamburger-btn fixed top-4 left-4 z-30 md:hidden bg-blue-600 text-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars" id="hamburger-icon"></i>
    </button>

    <!-- Sidebar -->
    <div class="flex">
        <aside class="sidebar w-64 h-screen text-white flex flex-col fixed left-0 top-0 z-10 shadow-2xl" id="sidebar" style="background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);">
            <div class="flex flex-col items-center justify-center h-20 py-2" style="border-bottom: 1px solid #1E40AF;">
                <div class="flex items-center">
                    <i class="fas fa-hospital-alt fa-2x mr-2"></i>
                    <span class="font-semibold text-xl tracking-tight">NIR Dashboard</span>
                </div>
                <span class="text-xs text-gray-400 mt-1" id="app-version">v3.2.0</span>
            </div>
            <nav class="flex-1 py-6">
                <ul class="space-y-2">
                    <li>
                        <a href="/painel" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition">
                            <i class="fas fa-bed mr-3"></i>
                            Ocupação de Leitos
                        </a>
                    </li>
                    <li>
                        <a href="/tempo_permanencia" class="flex items-center px-6 py-3 bg-blue-800 rounded transition">
                            <i class="fas fa-clock mr-3"></i>
                            Tempo de Permanência
                        </a>
                    </li>
                    <li>
                        <a href="/disponibilidade" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition">
                            <i class="fas fa-chart-area mr-3"></i>
                            Disponibilidade
                        </a>
                    </li>
                    <li>
                        <a href="/" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition">
                            <i class="fas fa-file-upload mr-3"></i>
                            Importação e Histórico
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-1 md:ml-64">
            <div class="container mx-auto mt-16 md:mt-8 px-4 pb-12">
                <!-- Header -->
                <nav class="bg-gradient-to-r from-gray-800 to-gray-900 p-4 shadow-2xl rounded-lg mb-6 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <h1 class="text-white font-semibold text-2xl">
                            <i class="fas fa-clock mr-2"></i>
                            Tempo de Permanência
                        </h1>
                        <div class="flex gap-2">
                            <button onclick="toggleTheme()" id="theme-toggle" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
                                <i id="theme-icon" class="fas fa-sun"></i>
                            </button>
                            <button onclick="toggleFilters()" class="bg-blue-900 hover:bg-blue-800 text-white px-4 py-2 rounded transition">
                                <i class="fas fa-filter mr-2"></i>
                                Filtros
                            </button>
                        </div>
                    </div>
                </nav>

        <!-- Filtros -->
        <div id="filters-panel" class="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 border border-gray-700 hidden">
            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-filter mr-2 text-blue-400"></i>Filtros</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2"><i class="fas fa-calendar-alt mr-1"></i>Data de Referência</label>
                    <input type="date" id="filter-data" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2"><i class="fas fa-hospital-user mr-1"></i>Clínica</label>
                    <select id="filter-clinica" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2"><i class="fas fa-building mr-1"></i>Prédio</label>
                    <select id="filter-predio" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="1">Prédio 1</option>
                        <option value="2">Prédio 2</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="applyFilters()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition"><i class="fas fa-check mr-1"></i>Aplicar</button>
                    <button onclick="clearFilters()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition"><i class="fas fa-times mr-1"></i>Limpar</button>
                    <button onclick="exportExcel()" id="export-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition"><i class="fas fa-file-excel mr-1"></i>Excel</button>
                </div>
            </div>
        </div>

        <!-- Cards -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
            <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg p-6 shadow-lg text-white card-hover" title="Número total de pacientes internados na data de referência">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm font-semibold uppercase mb-2">Total Pacientes Internados</div>
                        <div id="kp-total" class="text-3xl font-bold">-</div>
                    </div>
                    <div class="text-4xl opacity-50">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-lg p-6 shadow-lg text-white card-hover" title="Média de dias internados (todos os pacientes)">
                <div class="text-sm font-semibold uppercase mb-2">Permanência Média</div>
                <div id="kp-avg" class="text-3xl font-bold">-</div>
            </div>
            <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 rounded-lg p-6 shadow-lg text-white card-hover" title="Mediana de dias internados">
                <div class="text-sm font-semibold uppercase mb-2">Mediana (dias)</div>
                <div id="kp-med" class="text-3xl font-bold">-</div>
            </div>
            <div class="bg-gradient-to-br from-orange-600 to-orange-800 rounded-lg p-6 shadow-lg text-white card-hover" title="Pacientes com mais de 30 dias de internação">
                <div class="text-sm font-semibold uppercase mb-2">>30 dias</div>
                <div id="kp-30" class="text-3xl font-bold">-</div>
            </div>
            <div class="bg-gradient-to-br from-red-600 to-red-800 rounded-lg p-6 shadow-lg text-white card-hover" title="Pacientes com >30 dias e idade >=60 anos">
                <div class="text-sm font-semibold uppercase mb-2">>30d (>=60a)</div>
                <div id="kp-30-60" class="text-3xl font-bold">-</div>
            </div>
            <div class="bg-gradient-to-br from-pink-600 to-pink-800 rounded-lg p-6 shadow-lg text-white card-hover" title="Pacientes pediátricos (<18 anos) com >30 dias">
                <div class="text-sm font-semibold uppercase mb-2">>30d (Ped.)</div>
                <div id="kp-30-ped" class="text-3xl font-bold">-</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl card-hover animate-fade-in border border-gray-700">
                <h3 class="font-bold text-white mb-4 text-lg">
                    <i class="fas fa-chart-bar mr-2 text-blue-400"></i>
                    Histograma de Permanência
                </h3>
                <div style="height:300px"><canvas id="histogramChart"></canvas></div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl card-hover animate-fade-in border border-gray-700">
                <h3 class="font-bold text-white mb-4 text-lg">
                    <i class="fas fa-hospital-user mr-2 text-green-400"></i>
                    Longa Permanência por Clínica (Top 10)
                </h3>
                <div style="height:300px"><canvas id="clinicaChart"></canvas></div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl card-hover animate-fade-in border border-gray-700">
            <h3 class="font-bold text-white mb-4 text-lg">
                <i class="fas fa-list mr-2 text-yellow-400"></i>
                Pacientes - Longa Permanência (lista)
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="text-left text-sm text-gray-400">
                            <th class="px-2 py-1">Nome</th>
                            <th class="px-2 py-1">Prontuário</th>
                            <th class="px-2 py-1">Idade</th>
                            <th class="px-2 py-1">Clínica</th>
                            <th class="px-2 py-1">Data Internação</th>
                            <th class="px-2 py-1">Dias</th>
                        </tr>
                    </thead>
                    <tbody id="patients-body">
                        <tr><td colspan="6" class="px-2 py-4 text-gray-400">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <div id="pagination-info" class="text-sm text-gray-400"></div>
                <div class="flex gap-2">
                    <button id="btn-prev" onclick="prevPage()" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                    <span id="page-display" class="px-3 py-1 text-sm"></span>
                    <button id="btn-next" onclick="nextPage()" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">Próximo</button>
                </div>
            </div>
        </div>

    </div>

<script>
let currentPage = 1;
let perPage = 50;
let currentFilters = {};
let histChart = null;
let clinicaChart = null;

function toggleTheme(){
    const html = document.documentElement;
    const cur = html.getAttribute('data-theme') || 'dark';
    const next = cur === 'light' ? 'dark' : 'light';
    html.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
}

function loadTheme(){
    const saved = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    const icon = document.getElementById('theme-icon');
    if(icon) icon.className = saved === 'light' ? 'fas fa-moon' : 'fas fa-sun';
}

// Toggle mobile menu
function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('menu-overlay');
    const icon = document.getElementById('hamburger-icon');
    
    sidebar.classList.toggle('sidebar-hidden');
    overlay.classList.toggle('active');
    
    if (sidebar.classList.contains('sidebar-hidden')) {
        icon.className = 'fas fa-bars';
    } else {
        icon.className = 'fas fa-times';
    }
}

// Initialize mobile menu state
function initMobileMenu() {
    if (window.innerWidth < 768) {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.add('sidebar-hidden');
    }
}

// Close mobile menu on window resize to desktop
window.addEventListener('resize', () => {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('menu-overlay');
    if (window.innerWidth >= 768) {
        sidebar.classList.remove('sidebar-hidden');
        overlay.classList.remove('active');
    } else if (window.innerWidth < 768 && !overlay.classList.contains('active')) {
        sidebar.classList.add('sidebar-hidden');
    }
});

function toggleFilters() { 
    const panel = document.getElementById('filters-panel'); 
    panel.classList.toggle('hidden'); 
}

function applyFilters(){
    const data = document.getElementById('filter-data').value;
    const clinica = document.getElementById('filter-clinica').value;
    const predio = document.getElementById('filter-predio').value;
    currentFilters = {};
    if(data) currentFilters.data_referencia = data;
    if(clinica) currentFilters.clinica = clinica;
    if(predio) currentFilters.predio = predio;
    currentPage = 1;
    loadData();
    toggleFilters();
}
function clearFilters(){
    document.getElementById('filter-data').value = '';
    document.getElementById('filter-clinica').value = '';
    document.getElementById('filter-predio').value = '';
    currentFilters = {};
    currentPage = 1;
    loadData();
}

async function loadClinicasFilter(){
    try{
        const res = await fetch('/api/painel/clinicas');
        const data = await res.json();
        const select = document.getElementById('filter-clinica');
        data.labels.forEach(c => {
            const opt = document.createElement('option'); opt.value=c; opt.textContent=c; select.appendChild(opt);
        });
    }catch(e){console.error(e)}
}

function maskName(full){
    if(!full) return '';
    const parts = full.split(' ');
    if(parts.length===1){
        const s = parts[0];
        if(s.length<=2) return s[0] + '*';
        return s[0] + '*'.repeat(Math.max(1,s.length-2)) + s.slice(-1);
    }
    return parts[0] + ' ' + parts[parts.length-1][0] + '.';
}

async function loadData(){
    try{
        const qs = new URLSearchParams({...currentFilters, page: currentPage, per_page: perPage}).toString();
        const res = await fetch('/api/tempo_permanencia?' + qs);
        const json = await res.json();
        if(json.error){ console.error(json.error); return; }

        document.getElementById('kp-total').textContent = json.total_patients;
        document.getElementById('kp-avg').textContent = json.avg_los;
        document.getElementById('kp-med').textContent = json.median_los;
        document.getElementById('kp-30').textContent = json.long_gt_30;
        document.getElementById('kp-30-60').textContent = json.long_gt_30_60;
        document.getElementById('kp-30-ped').textContent = json.long_gt_30_ped;

        // Histogram
        const labels = Object.keys(json.histogram);
        const values = Object.values(json.histogram);
        const ctx = document.getElementById('histogramChart').getContext('2d');
        if(histChart) histChart.destroy();
        histChart = new Chart(ctx, {type:'bar', data:{labels, datasets:[{label:'Pacientes', data:values, backgroundColor:'rgba(59,130,246,0.8)'}]}, options:{responsive:true, maintainAspectRatio:false}});

        // Clinica chart: count clinic occurrences from full patient list (client-side aggregation for top 10)
        // Ideally backend should return aggregated clinic stats; here we aggregate from paginated results as MVP
        const clinRes = await fetch('/api/tempo_permanencia?'+ new URLSearchParams({...currentFilters, per_page:9999}).toString());
        const clinJson = await clinRes.json();
        const counts = {};
        (clinJson.patients || []).forEach(p => { if(p.clinica) counts[p.clinica] = (counts[p.clinica] || 0) + 1; });
        const sortedClinics = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const clinLabels = sortedClinics.map(c=>c[0]);
        const clinVals = sortedClinics.map(c=>c[1]);
        const cctx = document.getElementById('clinicaChart').getContext('2d');
        if(clinicaChart) clinicaChart.destroy();
        clinicaChart = new Chart(cctx, {type:'bar', data:{labels:clinLabels, datasets:[{label:'Longa permanência', data:clinVals, backgroundColor:'rgba(16,185,129,0.8)'}]}, options:{responsive:true, maintainAspectRatio:false, indexAxis:'y'}});

        // Table
        const tbody = document.getElementById('patients-body'); tbody.innerHTML='';
        const patients = json.patients || [];
        if(patients.length===0){
            tbody.innerHTML='<tr><td colspan="6" class="px-2 py-4 text-gray-400 text-center">Nenhum paciente encontrado</td></tr>';
        } else {
            for(const p of patients){
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/10';
                tr.innerHTML = `<td class="px-2 py-1">${p.nome_masked || maskName(p.nome)}</td>`+
                               `<td class="px-2 py-1">${p.prontuario || ''}</td>`+
                               `<td class="px-2 py-1">${p.idade || ''}</td>`+
                               `<td class="px-2 py-1">${p.clinica || ''}</td>`+
                               `<td class="px-2 py-1">${p.data_internacao || ''}</td>`+
                               `<td class="px-2 py-1 font-semibold">${p.dias}</td>`;
                tbody.appendChild(tr);
            }
        }
        const tableTotal = json.patients_table_total !== undefined ? json.patients_table_total : json.total_patients;
        const totalPages = Math.max(1, Math.ceil(tableTotal / perPage));
        document.getElementById('pagination-info').textContent = `Página ${json.page} de ${totalPages} — mostrando ${patients.length} de ${tableTotal}`;
        document.getElementById('page-display').textContent = `${json.page} / ${totalPages}`;
        document.getElementById('btn-prev').disabled = currentPage <= 1;
        document.getElementById('btn-next').disabled = currentPage >= totalPages;

    }catch(e){console.error(e)}
}

function prevPage(){ if(currentPage>1){ currentPage--; loadData(); }}
function nextPage(){ currentPage++; loadData(); }

function exportExcel(){
    const qs = new URLSearchParams(currentFilters).toString();
    const url = '/api/tempo_permanencia/export' + (qs ? ('?' + qs) : '');
    window.location = url;
}

document.addEventListener('DOMContentLoaded', ()=>{ loadTheme(); initMobileMenu(); loadClinicasFilter(); loadData(); });
// Load version and update UI
async function loadVersion(){
    try{ const r = await fetch('/api/version'); const j = await r.json(); document.getElementById('app-version').textContent = `v${j.version}`; }catch(e){/*ignore*/}
}
loadVersion();
</script>
            </div>
        </div>
    </div>
</body>
</html>