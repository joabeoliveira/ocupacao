<!DOCTYPE html>
<html class="dark" lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importação e Histórico - NIR Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            "primary": "#0b72d9",
                            "background-light": "#f7fbff",
                            "background-dark": "#0f1724",
                            "surface-light": "#ffffff",
                            "surface-dark": "#111827",
                            "text-primary-light": "#0b1724",
                            "text-primary-dark": "#e6eef8",
                            "text-secondary-light": "#4b5563",
                            "text-secondary-dark": "#9fb6d8",
                        }
                    }
                }
            }
        </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Variáveis de tema */
        :root {
            --bg-primary: #0f1724;
            --bg-secondary: #111827;
            --bg-tertiary: #0b1a2a;
            --text-primary: #e6eef8;
            --text-secondary: #9fb6d8;
            --text-tertiary: #9fb6d8;
            --border-color: #111827;
            --card-bg: linear-gradient(to bottom right, #111827, #0f1724);
            --sidebar-bg: #071025;
            --chart-blue: rgba(11, 114, 217, 0.85);
            --chart-green: rgba(22, 163, 74, 0.85);
            --chart-text: #e6eef8;
            --chart-grid: rgba(255, 255, 255, 0.06);
        }
        
        [data-theme="light"] {
            --bg-primary: #f7fbff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0b1724;
            --text-secondary: #4b5563;
            --text-tertiary: #6B7280;
            --border-color: #E5E7EB;
            --card-bg: linear-gradient(to bottom right, #ffffff, #f7fbff);
            --sidebar-bg: #1E3A8A;
            --chart-blue: rgba(11, 114, 217, 0.85);
            --chart-green: rgba(22, 163, 74, 0.85);
            --chart-text: #0b1724;
            --chart-grid: rgba(0, 0, 0, 0.06);
        }
        
        /* Classes utilitárias para tema */
        .bg-theme-primary { background-color: var(--bg-primary); }
        .bg-theme-secondary { background: var(--card-bg); }
        .text-theme-primary { color: var(--text-primary); }
        .text-theme-secondary { color: var(--text-secondary); }
        .text-theme-tertiary { color: var(--text-tertiary); }
        .border-theme { border-color: var(--border-color); }
        
        /* Estilos para inputs e selects - texto sempre legível */
        input, select {
            background-color: #FFFFFF !important;
            color: #111827 !important;
            border-color: #D1D5DB !important;
        }
        input::placeholder {
            color: #6B7280 !important;
        }
        
        /* Responsive mobile menu */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: none;
        }
        .sidebar-hidden { transform: translateX(-100%); }
        @media (max-width: 768px) {
            .sidebar { z-index: 20 !important; }
            .main-content { margin-left: 0 !important; }
        }
        @media (min-width: 769px) {
            .sidebar { transform: none !important; }
            .menu-overlay { display: none !important; }
        }
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9;
        }
        .menu-overlay.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="font-sans" style="background-color: var(--bg-primary);">
    <!-- Mobile Menu Overlay -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMobileMenu()"></div>
    
    <!-- Mobile Hamburger Button -->
    <button onclick="toggleMobileMenu()" class="hamburger-btn fixed top-4 left-4 z-30 md:hidden bg-blue-600 text-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars" id="hamburger-icon"></i>
    </button>

    <!-- Sidebar -->
    <div class="flex">
        <aside class="sidebar w-64 h-screen text-white flex flex-col fixed left-0 top-0 z-10 shadow-2xl" id="sidebar" style="background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);">
            <div class="flex flex-col items-center justify-center h-20 py-2" style="border-bottom: 1px solid #1E40AF;">
                <div class="flex items-center">
                    <i class="fas fa-hospital-alt fa-2x mr-2"></i>
                    <span class="font-semibold text-xl tracking-tight">NIR Dashboard</span>
                </div>
                <span class="text-xs text-gray-400 mt-1" id="app-version">v3.1.0</span>
            </div>
            <nav class="flex-1 py-6">
                <ul class="space-y-2">
                    <li>
                        <a href="/painel" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition">
                            <i class="fas fa-bed mr-3"></i>
                            Ocupação de Leitos
                        </a>
                    </li>
                    <li>
                        <a href="/tempo_permanencia" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition">
                            <i class="fas fa-clock mr-3"></i>
                            Tempo de Permanência
                        </a>
                    </li>
                    <li>
                        <a href="/disponibilidade" class="flex items-center px-6 py-3 hover:bg-blue-800 rounded transition">
                            <i class="fas fa-chart-area mr-3"></i>
                            Disponibilidade
                        </a>
                    </li>
                    <li>
                        <a href="/" class="flex items-center px-6 py-3 bg-blue-800 rounded transition">
                            <i class="fas fa-file-upload mr-3"></i>
                            Importação e Histórico
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-1 md:ml-64">
            <div class="container mx-auto mt-16 md:mt-8 px-4 pb-12">
                <!-- Header -->
                <nav class="bg-gradient-to-r from-gray-800 to-gray-900 p-4 shadow-2xl rounded-lg mb-6 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <h1 class="text-white font-semibold text-2xl">
                            <i class="fas fa-upload mr-2"></i>
                            Importação e Histórico
                        </h1>
                        <div id="data-display" class="text-white text-sm bg-blue-900 px-4 py-2 rounded hidden">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            <span id="data-atual"></span>
                        </div>
                        <button onclick="toggleTheme()" id="theme-toggle"
                            class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition ml-2">
                            <i class="fas fa-sun" id="theme-icon"></i>
                        </button>
                    </div>
                </nav>

                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="container mx-auto px-4">
                    {% for category, message in messages %}
                        <div class="mb-4 p-4 rounded {% if category == 'success' %}bg-green-600 text-white{% elif category == 'error' %}bg-red-600 text-white{% else %}bg-gray-600 text-white{% endif %}" style="word-break:break-word;">{{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <!-- Upload Section -->
                <div class="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 card-hover border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-cloud-upload-alt mr-2 text-blue-400"></i>
                        Importar Dados de Ocupação
                    </h2>
                    <form action="/upload" method="POST" enctype="multipart/form-data" class="space-y-4" id="upload-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-file-csv mr-1"></i>
                                    Arquivo (CSV / XLS / XLSX)
                                </label>
                                <input type="file" name="file" required accept=".csv,.xls,.xlsx"
                                    class="w-full px-4 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="upload-file-input" aria-label="Escolha um arquivo CSV ou Excel (.csv, .xls, .xlsx)" aria-describedby="upload-help upload-msg" title="Aceita .csv, .xls, .xlsx — o cabeçalho deve estar na 3ª linha">
                                <div class="flex items-start mt-2">
                                    <p id="upload-help" class="text-xs text-gray-400">Tipos aceitos: <strong>.csv</strong>, <strong>.xls</strong>, <strong>.xlsx</strong>. As duas primeiras linhas do arquivo serão ignoradas (o cabeçalho deve estar na 3ª linha).</p>

                                    <div class="ml-2 relative group" style="display:inline-block">
                                        <i class="fas fa-question-circle text-gray-400 ml-2 cursor-pointer" tabindex="0" aria-haspopup="true" aria-controls="upload-tooltip" aria-expanded="false"></i>
                                        <div id="upload-tooltip" role="tooltip" aria-hidden="true"
                                            class="absolute z-50 left-0 mt-8 w-72 p-2 text-xs text-white bg-black rounded shadow-lg
                                                   opacity-0 translate-y-1 pointer-events-none
                                                   transition-opacity transition-transform duration-200
                                                   group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto
                                                   group-focus:opacity-100 group-focus:translate-y-0 group-focus:pointer-events-auto">
                                            Aceitamos arquivos <strong>.csv</strong>, <strong>.xls</strong> e <strong>.xlsx</strong>. O sistema ignora as duas primeiras linhas do arquivo; coloque o cabeçalho na 3ª linha e os dados a partir da 4ª linha.
                                        </div>
                                    </div>
                                </div>
                                <div id="upload-msg" class="mt-2" role="status" aria-live="polite"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-calendar mr-1"></i>
                                    Data de Referência
                                </label>
                                <input type="date" name="data_referencia" required
                                    class="w-full px-4 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105" aria-label="Importar arquivo — ignora as duas primeiras linhas" title="Importa arquivo e ignora as duas primeiras linhas">
                            <i class="fas fa-upload mr-2"></i>
                            Importar — ignora 2 primeiras linhas
                        </button>
                    </form>
                </div>

                <!-- Delete records for a given date -->
                <div class="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 card-hover border border-gray-700">
                    <h2 class="text-lg font-bold text-white mb-3">
                        <i class="fas fa-trash-alt mr-2 text-red-400"></i>
                        Excluir Registros por Data
                    </h2>
                    <p class="text-sm text-gray-400 mb-3">Use para apagar todos os registros de uma data específica (irreversível).</p>
                    <form action="/delete_date" method="POST" class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Data alvo</label>
                            <input type="date" name="target_date" required class="w-full px-4 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg">
                        </div>
                        <div class="col-span-2 flex items-center">
                            <input type="checkbox" id="confirm" name="confirm" class="mr-2">
                            <label for="confirm" class="text-sm text-gray-300">Confirmo que desejo excluir todos os registros desta data</label>
                        </div>
                        <div>
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">
                                <i class="fas fa-trash mr-2"></i>Excluir
                            </button>
                        </div>
                    </form>
                    <p class="text-xs text-gray-500 mt-3">Recomendação: faça backup do banco antes de confirmar.</p>
                </div>

                <!-- Quick Date Correction: move records from one date to another -->
                    <div class="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 card-hover border border-gray-700">
                        <h2 class="text-lg font-bold text-white mb-3">
                            <i class="fas fa-exchange-alt mr-2 text-yellow-300"></i>
                            Corrigir Data de Importação (mover registros)
                        </h2>
                        <p class="text-sm text-gray-400 mb-3">Se você importou registros na data errada, mova-os para a data correta. Isso atualiza apenas o campo <strong>data_referencia</strong>.</p>
                        <form action="/fix_date" method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">Data atual (errada)</label>
                                <input type="date" name="from_date" required
                                    class="w-full px-4 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">Data correta (nova)</label>
                                <input type="date" name="to_date" required
                                    class="w-full px-4 py-2 bg-gray-900 text-white border border-gray-600 rounded-lg">
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg">
                                    <i class="fas fa-check mr-2"></i>Confirmar e Mover
                                </button>
                            </div>
                        </form>
                        <p class="text-xs text-gray-500 mt-3">Atenção: esta operação altera registros existentes. Faça backup do banco antes em produção.</p>
                    </div>

                <!-- Loading Skeleton -->
                <div id="loading-skeleton" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="skeleton h-24 rounded-lg"></div>
                        <div class="skeleton h-24 rounded-lg"></div>
                        <div class="skeleton h-24 rounded-lg"></div>
                        <div class="skeleton h-24 rounded-lg"></div>
                    </div>
                    <div class="skeleton h-64 rounded-lg"></div>
                </div>

                <!-- Stats Cards -->
                <div id="stats-section" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 animate-fade-in">
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-blue-500 card-hover border border-gray-700">
                            <div class="text-gray-400 text-sm font-bold uppercase mb-2">
                                <i class="fas fa-hospital mr-1"></i>
                                Total de Leitos
                            </div>
                            <div class="text-4xl font-bold text-blue-400" id="stat-total">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-red-500 card-hover border border-gray-700">
                            <div class="text-gray-400 text-sm font-bold uppercase mb-2">
                                <i class="fas fa-user-injured mr-1"></i>
                                Ocupados
                            </div>
                            <div class="text-4xl font-bold text-red-400" id="stat-ocupados">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-yellow-500 card-hover border border-gray-700">
                            <div class="text-gray-400 text-sm font-bold uppercase mb-2">
                                <i class="fas fa-tools mr-1"></i>
                                Impedidos
                            </div>
                            <div class="text-4xl font-bold text-yellow-400" id="stat-impedidos">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 shadow-2xl border-l-4 border-green-500 card-hover border border-gray-700">
                            <div class="text-gray-400 text-sm font-bold uppercase mb-2">
                                <i class="fas fa-bed mr-1"></i>
                                Vagos
                            </div>
                            <div class="text-4xl font-bold text-green-400" id="stat-vagos">0</div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl mb-6 card-hover animate-fade-in border border-gray-700">
                        <h3 class="font-bold text-white mb-4 text-lg">
                            <i class="fas fa-chart-line mr-2 text-blue-400"></i>
                            Evolução da Ocupação (Últimos 7 Dias)
                        </h3>
                        <div style="height: 300px">
                            <canvas id="occupancyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="bg-gray-800 rounded-lg shadow-2xl p-6 animate-fade-in border border-gray-700">
                    <h3 class="font-bold text-white mb-4 text-lg">
                        <i class="fas fa-history mr-2 text-blue-400"></i>
                        Histórico de Importações
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-900">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Total Leitos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Ocupados</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Taxa</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="bg-gray-900 divide-y divide-gray-700">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>
                                        Carregando histórico...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentChart = null;

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update icon
            const icon = document.getElementById('theme-icon');
            icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            
            // Reload chart with new theme colors
            if (currentChart) loadChart();
        }
        
        // Load theme from localStorage
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('menu-overlay');
            const icon = document.getElementById('hamburger-icon');
            sidebar.classList.toggle('sidebar-hidden');
            overlay.classList.toggle('active');
            icon.className = sidebar.classList.contains('sidebar-hidden') ? 'fas fa-bars' : 'fas fa-times';
        }

        // Initialize mobile menu state
        function initMobileMenu() {
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('sidebar-hidden');
            }
        }

        // Close mobile menu on window resize to desktop
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('menu-overlay');
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('sidebar-hidden');
                overlay.classList.remove('active');
            } else if (!overlay.classList.contains('active')) {
                sidebar.classList.add('sidebar-hidden');
            }
        });

        // Load stats
        async function loadStats(data = null) {
            try {
                const url = data ? `/api/stats?data=${data}` : '/api/stats';
                const response = await fetch(url);
                const stats = await response.json();
                
                if (stats.error) {
                    document.getElementById('loading-skeleton').classList.add('hidden');
                    document.getElementById('stats-section').classList.add('hidden');
                    return;
                }
                
                document.getElementById('stat-total').textContent = stats.total;
                document.getElementById('stat-ocupados').textContent = stats.ocupados;
                document.getElementById('stat-impedidos').textContent = stats.impedidos;
                document.getElementById('stat-vagos').textContent = stats.vagos;
                
                if (stats.data_referencia) {
                    // Parse date correctly to avoid timezone issues
                    const dateParts = stats.data_referencia.split('-');
                    const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                    document.getElementById('data-atual').textContent = 
                        `Visualizando: ${date.toLocaleDateString('pt-BR')}`;
                    document.getElementById('data-display').classList.remove('hidden');
                }
                
                document.getElementById('loading-skeleton').classList.add('hidden');
                document.getElementById('stats-section').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
                document.getElementById('loading-skeleton').classList.add('hidden');
            }
        }

        // Load chart
        async function loadChart(data = null) {
            try {
                const url = data ? `/api/chart?data=${data}` : '/api/chart';
                const response = await fetch(url);
                const chartData = await response.json();
                
                if (chartData.error) return;
                
                const ctx = document.getElementById('occupancyChart').getContext('2d');
                
                if (currentChart) {
                    currentChart.destroy();
                }
                
                // Cores baseadas no tema usando variáveis CSS
                const theme = document.documentElement.getAttribute('data-theme');
                const isDark = theme !== 'light';
                const styles = getComputedStyle(document.documentElement);
                const chartBlue = styles.getPropertyValue('--chart-blue').trim();
                const chartText = styles.getPropertyValue('--chart-text').trim();
                const chartGrid = styles.getPropertyValue('--chart-grid').trim();
                const lineColor = isDark ? '#60A5FA' : '#2563EB';
                const gridColor = chartGrid || (isDark ? '#374151' : '#E5E7EB');
                const textColor = chartText || (isDark ? '#9CA3AF' : '#6B7280');
                const legendColor = isDark ? '#E5E7EB' : '#374151';
                const bgColor = isDark ? 'rgba(96,165,250,0.12)' : 'rgba(37,99,235,0.20)';

                const chartShadowPlugin = {
                    id: 'shadowPlugin',
                    beforeDatasetsDraw(chart, args, options) {
                        const ctx = chart.ctx;
                        ctx.save();
                        const cfg = chart.config.options.plugins && chart.config.options.plugins.shadow || {};
                        ctx.shadowColor = cfg.color || (isDark ? 'rgba(0,0,0,0.6)' : 'rgba(16,24,40,0.06)');
                        ctx.shadowBlur = cfg.blur || 12;
                    },
                    afterDatasetsDraw(chart, args, options) {
                        chart.ctx.restore();
                    }
                };

                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Pacientes Internados',
                            data: chartData.data,
                            borderColor: lineColor,
                            backgroundColor: bgColor,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: lineColor,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    plugins: [chartShadowPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            shadow: { color: isDark ? 'rgba(0,0,0,0.6)' : 'rgba(16,24,40,0.06)', blur: 12 },
                            legend: { 
                                display: true,
                                labels: { color: legendColor }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar gráfico:', error);
            }
        }

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                if (data.error || !data.history || data.history.length === 0) {
                    document.getElementById('history-table-body').innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">
                                <i class="fas fa-inbox mr-2"></i>
                                Nenhum histórico encontrado
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                document.getElementById('history-table-body').innerHTML = data.history.map(row => {
                    const taxa = ((row.ocupados / row.total) * 100).toFixed(1);
                    return `
                        <tr class="hover:bg-gray-800 transition">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
                                <i class="fas fa-calendar-day mr-2 text-blue-400"></i>
                                ${row.data_formatada}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${row.total}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${row.ocupados}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                    taxa >= 80 ? 'bg-red-900 text-red-300' : 
                                    taxa >= 60 ? 'bg-yellow-900 text-yellow-300' : 
                                    'bg-green-900 text-green-300'
                                }">
                                    ${taxa}%
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="loadDataForDate('${row.data_referencia}')" 
                                    class="text-blue-400 hover:text-blue-300 font-medium transition">
                                    <i class="fas fa-eye mr-1"></i>
                                    Visualizar
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
            }
        }

        // Load data for specific date
        function loadDataForDate(date) {
            loadStats(date);
            loadChart(date);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Load version
        async function loadVersion() {
            try {
                const response = await fetch('/api/version');
                const data = await response.json();
                document.getElementById('app-version').textContent = `v${data.version}`;
            } catch (error) {
                console.log('Versão estática mantida');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            initMobileMenu();
            loadVersion();
            loadStats();
            loadChart();
            loadHistory();

            // Client-side validation for upload: aceita .csv, .xls, .xlsx
            const uploadForm = document.getElementById('upload-form');
            const uploadInput = document.getElementById('upload-file-input');
            const uploadMsg = document.getElementById('upload-msg');
            const allowedExt = ['.csv', '.xls', '.xlsx'];

            if (uploadInput) {
                uploadInput.addEventListener('change', () => {
                    // limpa mensagem anterior
                    if (uploadMsg) uploadMsg.innerHTML = '';
                });
            }

            if (uploadForm) {
                uploadForm.addEventListener('submit', (e) => {
                    if (!uploadInput || !uploadInput.files || uploadInput.files.length === 0) return;
                    const fname = uploadInput.files[0].name.toLowerCase();
                    const ok = allowedExt.some(ext => fname.endsWith(ext));
                    if (!ok) {
                        e.preventDefault();
                        if (uploadMsg) {
                            uploadMsg.innerHTML = `<div class="p-3 rounded bg-red-600 text-white text-sm">Tipo inválido. Envie um arquivo <strong>.csv</strong>, <strong>.xls</strong> ou <strong>.xlsx</strong>.</div>`;
                        } else {
                            alert('Tipo inválido. Envie .csv, .xls ou .xlsx');
                        }
                        uploadInput.focus();
                        return false;
                    }
                    // mostra nota de processamento
                    if (uploadMsg) uploadMsg.innerHTML = `<div class="p-2 rounded bg-green-700 text-white text-sm">Arquivo aceito. As duas primeiras linhas serão ignoradas na importação.</div>`;
                });
            }
        });
    </script>
</body>
</html>
